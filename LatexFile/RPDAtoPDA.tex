\subsection{PDA simulating RPDA}

%Let $\lab:((\Sigma\cup\{\tau\})\times D)\to(\Sigma\cup\{\tau\})$
%be the function
%defined as $\lab((a,d))=a$
%for any $a\in\Sigma\cup\{\tau\}$ and $d\in D$.
In this subsection, we show that we can construct an NPDA $\calA'$
from a given $k$-NRPDA $\calA$ over $\SigmaI$, $\SigmaO$, $\Gamma$
such that $\lab(L(\calA))=L(\calA')$.

Let $\Phi_k$ be the set of
\emph{equivalence relations}
over the set of $2k+1$ symbols
$X_k=\{
 \L_1,\L_2,\ldots,\L_k,
 \R_1,\R_2,\ldots,\R_k,
 \Ltop \}$.
 We write $a\equiv_{\phi}b$ and $a\not\equiv_{\phi}b$ to mean
 $(a,b)\in\phi$ and $(a,b)\notin\phi$, respectively,
for $a,b\in X_k$ and $\phi\in\Phi_k$.
%
Intuitively,
each $\phi\in\Phi_k$ represents the equality and inequality
among the data values in the registers and the stack top,
as well as the transfer of the values in the registers
between two assignments.
Two assignments $\theta,\theta'$ and a value $d$ at the stack top
satisfy $\phi$,
denoted as $\theta,d,\theta'\models\phi$,
if and only if for $i,j\in[k]$,
\begin{align*}
  \L_i\equiv_{\phi}\L_j &\Leftrightarrow \theta(i)=\theta(j),
  & \L_i\equiv_{\phi}\Ltop &\Leftrightarrow \theta(i)=d, \\
  \L_i\equiv_{\phi}\R_j &\Leftrightarrow \theta(i)=\theta'(j),
  & \R_j\equiv_{\phi}\Ltop &\Leftrightarrow \theta'(j)=d , \\
  \R_i\equiv_{\phi}\R_j &\Leftrightarrow \theta'(i)=\theta'(j).
\end{align*}
%
Let $\phizero\in\Phi_k$ be the equivalence relation
satisfying $a\equiv_{\phizero}b$ for any $a,b\in X_k$.

For $\tst\subseteq [k]\cup\{\top\}$ and $\asgn\subseteq [k]$,
define a subset $\Phi_k^{\tst,\asgn}$ of $\Phi_k$ as:
\[
  \Phi_k^{\tst,\asgn} = \{ \phi\in\Phi_k \mid
    \begin{aligned}[t]
      & (\forall i\in\rlap{$\tst :{}$}\hphantom{\asgn:{}}
      \forall j\in [k]\cup\{\top\} :
      j\in\tst \Leftrightarrow \L_i \equiv_{\phi} \L_j), \\
      & (\forall i\in\asgn : \forall j\in [k]\cup\{\top\} :
      j\in\tst \Leftrightarrow \L_j \equiv_{\phi} \R_i), \\
      & (\forall i,j\in\asgn :
      \R_i \equiv_{\phi} \R_j), \
       (\forall i\in [k]\setminus\asgn :
      \L_i \equiv_{\phi} \R_i)\}.
    \end{aligned}
\]
For $j\in[k]$, define
$
  \Phi_k^{=,j} = \{ \phi\in\Phi_k \mid
    \Ltop \equiv_{\phi} \L_j, \
    \forall i\in[k] : \L_i \equiv_{\phi} \R_i \}
$.
By definition,
$\theta,e,\theta'\models\phi$ for
%$\theta,\theta'\in\Theta_k$, $e\in D$, and
$\phi\in\Phi_k^{\tst,\asgn}$
iff
$\theta,d,e\models\tst$ and
$\theta'=\theta[\asgn\gets d]$ for some $d\in D$.
Similarly,
$\theta,e,\theta'\models\phi$ for
$\phi\in\Phi_k^{=,j}$
iff
$\theta'=\theta$ and $\theta(j)=e$.

Let $\COMPBL$ and $\COMPBLT$ be binary predicates over $\Phi_k$ defined as:
\begin{align*}
  \phi_1\COMPBL\phi_2 \ &:\Leftrightarrow \
      \R_i \equiv_{\phi_1} \R_j \Leftrightarrow \L_i \equiv_{\phi_2} \L_j
      \ \text{for } i,j\in[k].
  \\
%
  \phi_1\COMPBLT\phi_2 \ &:\Leftrightarrow \
      \phi_1\COMPBL\phi_2 \ \text{and} \
      \R_i \equiv_{\phi_1} \Ltop \Leftrightarrow \L_i \equiv_{\phi_2} \Ltop
      \ \text{for } i\in[k].
\end{align*}
%We say $\phi_1$ and $\phi_2$ are \emph{composable} if $\phi_1\COMPBLT\phi_2$.
Below we will define the \emph{composition} of two equivalence relations,
and $\phi_1\COMPBL\phi_2$ means that
$\phi_1$ and $\phi_2$ are composable.
%
For $\phi\in\Phi_k$ and $\Phi'\subseteq\Phi_k$,
let $\phi\COMPBL\Phi' = \{\phi'\in\Phi' \mid \phi\COMPBL\phi'\}$
and $\phi\COMPBLT\Phi' = \{\phi'\in\Phi' \mid \phi\COMPBLT\phi'\}$.
By definition,
$\phi\COMPBLT\Phi_k^{\tst,\asgn}$ consists of at most one equivalence relation
for any $\phi\in\Phi_k$, $\tst\subseteq [k]\cup\{\top\}$,
and $\asgn\subseteq[k]$.
Similarly,
$\phi\COMPBL\Phi_k^{=,j}$ consists of exactly one equivalence relation
for any $\phi\in\Phi_k$ and $j\in [k]$.


For $\phi_1,\phi_2\in\Phi_k$ with $\phi_1\COMPBL\phi_2$,
the \emph{composition} $\phi_1\COMP\phi_2$ of them
is the equivalence relation in $\Phi_k$ that satisfies the followings:
\begin{align*}
  \L_i \equiv_{\phi_1} \L_j &\Leftrightarrow
  \L_i \equiv_{\phi_1\COMP\phi_2} \L_j &&\text{for } i,j\in [k]\cup\{\top\},\\
  \R_i \equiv_{\phi_2} \R_j &\Leftrightarrow
  \R_i \equiv_{\phi_1\COMP\phi_2} \R_j &&\text{for } i,j\in [k],\\
  (\exists l\in [k] : \L_i \equiv_{\phi_1} \R_l \mathrel{\land}
  \L_l \equiv_{\phi_2} \R_j) &\Leftrightarrow
  \L_i \equiv_{\phi_1\COMP\phi_2} \R_j
  &&\text{for } i\in[k]\cup\{\top\},\ j\in [k].
\end{align*}
%
By definition,
if $\theta_1,d_1,\theta_2\models\phi_1$ and
$\theta_2,d_2,\theta_3\models\phi_2$,
then
$\theta_1\,d_1,\theta_3\models\phi_1\COMP\phi_2$.
By definition, $\COMP$ is associative.

%%%%%%%%%%
\smallskip

Let $\calA=(Q,\QI,\QO,q_0,\delta,c)$ be a $k$-NRPDA
over $\SigmaI$, $\SigmaO$, and $\Gamma$.
As mentioned in Section~\ref{sec:RA},
we assume that $\Gamma$ is a singleton and
use the simplified definition of $\delta$ for readability.
Note that we can extend the following results to arbitrary $\Gamma$
by replacing $\Phi_k$ used as the stack alphabet of
the constructed PDA with $\Gamma\times\Phi_k$.
%
From $\calA$, we construct a PDA
$\calA'=(Q',\QI',\QO',q'_0,\phizero,\delta',c')$
over $\SigmaI$, $\SigmaO$, and $\Phi_k$,
where $Q'=Q\times\Phi_k$, $\QI'=\QI\times\Phi_k$, $\QO'=\QO\times\Phi_k$,
$q'_0=(q_0,\phizero)$,
$c'((q,\phi))=c(q)$ for any $q\in Q$ and $\phi\in\Phi_k$,
and for any $(q,\phi_2)\in Q'$, $a\in\Sigma\cup\{\tau\}$,
and $\phi_1\in\Phi_k$,
$\delta'((q,\phi_2),a,\phi_1)$ is the smallest set
satisfying the following inference rules:
%We write $(q,a,\tst)\to(q',\asgn,\COM)\in\delta$ to mean
%$(q',\asgn,\COM)\in\delta(q,a,\tst)$.
%
\begin{align}
&
\begin{array}{l}
  \delta(q,a,\tst) \ni (q',\asgn,\skip), \
  \phi_1\COMPBL\phi_2, \
  \phi_3\in \phi_2\COMPBLT\Phi_k^{\tst,\asgn}
  \\ \hline
  \delta'((q,\phi_2),a,\phi_1) \ni ((q',\phi_2\COMP\phi_3),\skip)
\end{array}\label{eq: PDAtoRPDA1}
%
\\[\medskipamount]
&
\begin{array}{l}
  \delta(q,a,\tst) \ni (q',\asgn,\pop), \
  \phi_1\COMPBL\phi_2, \
  \phi_3\in \phi_2\COMPBLT\Phi_k^{\tst,\asgn}
  \\ \hline
  \delta'((q,\phi_2),a,\phi_1) \ni ((q',\phi_1\COMP\phi_2\COMP\phi_3),\pop)
\end{array}\label{eq: PDAtoRPDA2}
%
\\[\medskipamount]
&
\begin{array}{l}
  \delta(q,a,\tst) \ni (q',\asgn,\push(j)), \
  \phi_1\COMPBL\phi_2, \
  \phi_3\in \phi_2\COMPBLT\Phi_k^{\tst,\asgn}, \
  \phi_4\in \phi_3\COMPBL\Phi_k^{=,j}
  \\ \hline
  \delta'((q,\phi_2),a,\phi_1) \ni ((q',\phi_4),\push(\phi_2\COMP\phi_3))
\end{array}\label{eq: PDAtoRPDA3}
%
\end{align}
Note that if $\calA$ is a test-visibly DRPDA,
$\calA'$ is deterministic.
The number of equivalence relations in $\Phi_k$ equals
the $(2k+1)$th Bell number
and is $2^{O(k\log k)}$.
When constructing $\delta'$,
we choose arbitrary $\phi_1$ and $\phi_2$ for each transition rule of
$\calA$ in general,
and thus the size of $\calA'$ is exponential to the one of $\calA$.

The main idea of this construction is as follows:
$\calA'$ simulates $\calA$ without keeping data values in
the stack.
When $\pop$ is performed,
$\calA'$ must know whether or not
the data value in the new stack top of $\calA$
equals the \emph{current} value of each register.
For this purpose,
$\calA'$ keeps an abstract ``history'' of
the register assignments in the stack,
which tells whether
each of the data values in the stack of $\calA$ equals
the current value of each register.
The precise meanings of the stack of $\calA'$
will become clear
by considering the $\lab$-bisimulation relation
shown in the proof of Lemma~\ref{lemma:bisim-rpda-pda} below.

Let $\calS_{\calA}=(\ID_{\!\calA},(q_0,\theta_{\bot},\bot),
\Sigma\times D,\{\tau\}\times D,{\vdash_{\!\calA}},c_{\calA})$
and $\calS_{\calA'}=(\ID_{\!\calA'},(q'_0,\phizero),\allowbreak
\Sigma,\{\tau\},{\vdash_{\!\calA'}},c_{\calA'})$ be the TSs
that represent the semantics of $\calA$ and $\calA'$, respectively.
Below we show that $\calS_{\calA}$ is $\lab$-bisimilar to
$\calS_{\calA'}$.
We define an intermediate TS
$\calS_{\calA}^{\AUG}=
(\ID_{\!\calA}^{\AUG},(q_0,\theta_{\bot},(\bot,\theta_{\bot})),
\Sigma\times D,\{\tau\}\times D,{\vdash_{\!\calA^{\AUG}}},c'_{\calA})$
where
$\ID_{\!\calA}^{\AUG}=Q\times\Theta_k\times(D\times\Theta_k)^*$,
$c'_{\calA}((q,\theta,v))=c_{\calA}((q,\theta,\fst(v)))$ for
any $(q,\theta,v)\in\ID_{\!\calA}^{\AUG}$,
and $\vdash_{\!\calA^{\AUG}}$ is defined as follows:
$(q,\theta,v)\vdash_{\!\calA^{\AUG}}^{(a,d)}(q',\theta',v')$
if and only if
$\delta(q,a,\tst)\ni (q',\asgn,\com)$,
$d,\fst(v(0)),\theta\models\tst$,
$\theta'=\theta[\asgn\gets d]$, and
$v'= v(1{:})$, $v$, or $(\theta'(j'),\theta')v$
if $\com=\pop$, $\skip$, or $\push(j')$, respectively.
$\calS_{\calA}$ and $\calS_{\calA}^{\AUG}$ are essentially
the same TSs but $\calS_{\calA}^{\AUG}$
``saves'' the current register assignment in the stack.
The saved assignments do not take part in transitions and thus
%the behaviors of 
%$\calS_{\calA}$ and $\calS_{\calA}^{\AUG}$ are the same.
%Obviously,
$\calS_{\calA}$ and $\calS_{\calA}^{\AUG}$ are obviously bisimilar;
the smallest relation $R\subseteq \ID_{\!\calA}\times\ID_{\!\calA}^{\AUG}$
satisfying
$((q,\theta,\fst(v)),\allowbreak (q,\theta,v))\in R$
for every $(q,\theta,v)\in\ID_{\!\calA}^{\AUG}$
is a bisimulation relation
between $\calS_{\calA}$ and $\calS_{\calA}^{\AUG}$.
%
On the other hand,
each equivalence relation in the stack of $\calA'$ represents
the relation among each data value in the stack and
two adjacent saved assignments
of $\calS_{\calA}^{\AUG}$,
which yields $\lab$-bisimilarity from
$\calS_{\calA}^{\AUG}$ to $\calS_{\calA'}$,
as shown in the following lemma.
%
\begin{lemma}\label{lemma:bisim-rpda-pda}
$\calS_{\calA}^{\AUG}$ is $\lab$-bisimilar to
$\calS_{\calA'}$.
\end{lemma}
%
{\bf Proof sketch.}\quad
Let $R\subseteq \ID_{\!\calA}^{\AUG}\times\ID_{\!\calA'}$
be the smallest relation
that satisfies
for every $q\in Q$, $\theta_0,\ldots,\theta_n\in\Theta_k$,
$d_0,\ldots,d_{n-1}\in D$, and $\phi_0,\ldots,\phi_n\in\Phi_k$,
$((q,\theta_n,(d_{n-1},\theta_{n-1})\allowbreak\ldots\allowbreak
(d_1,\theta_1)(d_0,\theta_0)),
((q,\phi_n),\phi_{n-1}\ldots\phi_1\phi_0))\in R$
if
$\forall i\in[n]: \theta_{i-1},d_{i-1},\theta_i\models\phi_i$ and
$\theta_{\bot},{\bot},\theta_0\models\phi_0$.
%
If
$((q,\theta_n,v), ((q,\phi_n),u))\in R$ and
$(q,\theta_n,v)\vdash_{\calA^{\AUG}}^{(a,d)}(q',\theta',v')$,
then by the definition of $\delta'$,
$((q,\phi_n),u)\vdash_{\calA'}^a ((q',\phi''),u')$
such that $((q',\theta',v'), ((q',\phi''),u'))\in R$.
Conversely, if
$((q,\theta_n,v),\allowbreak ((q,\phi_n),u))\in R$ and
$((q,\phi_n),u)\vdash_{\calA'}^a ((q',\phi''),u')$,
then by the definition of $\delta'$,
there must be a transition of $\calA$ that enables
$(q,\theta_n,v)\vdash_{\calA^{\AUG}}^{(a,d)} (q',\theta',v')$
such that $((q',\theta',v'), ((q',\phi''),u'))\in R$.
%
Therefore, $R$ is a $\lab$-bisimulation relation from
$\calS_{\calA}^{\AUG}$ to $\calS_{\calA'}$.

\smallskip

By Lemmas~\ref{lemma:bisim-lang} and \ref{lemma:bisim-rpda-pda},
we obtain the following theorem.
\begin{theorem}
\label{the: RPDAtoPDA}
For a given $(m,k)$-NRPDA (resp.\ test-visibly $(m,k)$-DRPDA) $\calA$,
we can construct an $m$-NPDA (resp.\ $m$-DPDA) $\calA'$
such that $\lab(L(\calA))=L(\calA')$.
\end{theorem}

-----------------------------------------------------

A full proof of Lemma~\ref{lemma:bisim-rpda-pda}

%\begin{proof}
Let $R\subseteq \ID_{\!\calA}^{\AUG}\times\ID_{\!\calA'}$
be the smallest relation
that satisfies
for every $q\in Q$, $\theta_0,\ldots,\theta_n\in\Theta_k$,
$d_0,\ldots,d_{n-1}\in D$, and $\phi_0,\ldots,\phi_n\in\Phi_k$,
$((q,\theta_n,(d_{n-1},\theta_{n-1})\allowbreak\ldots\allowbreak
(d_1,\theta_1)(d_0,\theta_0)),
((q,\phi_n),\phi_{n-1}\ldots\phi_1\phi_0))\in R$
if
$\forall i\in[n]: \theta_{i-1},d_{i-1},\theta_i\models\phi_i$ and
$\theta_{\bot},{\bot},\theta_0\models\phi_0$.
%
We can show that $R$ is a $\lab$-bisimulation relation from
$\calS_{\calA}^{\AUG}$ to $\calS_{\calA'}$.

Assume that
$((q,\theta_n,v),\allowbreak ((q,\phi_n),u))\in R$
for $v=(d_{n-1},\theta_{n-1})\ldots(d_0,\theta_0)$ and
$u=\phi_{n-1}\ldots\phi_0$.
Because
$\forall i\in[n]: \theta_{i-1},d_{i-1},\theta_i\models\phi_i$ and
$\theta_{\bot},{\bot},\theta_0\models\phi_0$,
$\forall i\in[n]: \phi_{i-1}\COMPBL\phi_i$.
%
If
$(q,\theta_n,v)\vdash_{\calA^{\AUG}}^{(a,d)}(q',\theta',v')$,
then
there exist $\tst$, $\asgn$, $\com$, and $d$ such that
$\delta(q,a,\tst)\ni (q',\asgn,\com)$,
$\theta_n,d,d_{n-1}\models\tst$,
$\theta'=\theta_n[\asgn\gets d]$, and
$v'=v(1{:})$, $v$, or
$(\theta'(j'),\theta')v$
if $\com=\pop$, $\skip$, or $\push(j')$, respectively.
There exists $\phi'\in\phi_n\COMPBLT\Phi_k^{\tst,\asgn}$ because
$\theta_{n-1},d_{n-1},\theta_n\models\phi_n$ and
$\theta_n,d,d_{n-1}\models\tst$.
Thus, by definition,
$\delta'((q,\phi_n),a,\phi_{n-1})\allowbreak\ni ((q',\phi''),\com')$
where $\com'=\pop$ and $\phi''=\phi_{n-1}\COMP\phi_n\COMP\phi'$
if $\com=\pop$,
$\com'=\skip$ and $\phi''=\phi_n\COMP\phi'$ if $\com=\skip$, and
$\com'=\push(\phi_n\COMP\phi')$ and $\phi''\in\phi'\COMPBL\Phi_k^{=,j'}$
if $\com=\push(j')$.
Therefore,
$((q,\phi_n),u)\vdash_{\calA'}^a ((q',\phi''),u')$
where $u'=\upds(u,\com')$.
Because $\theta_{n-1},d_{n-1},\theta_n\models\phi_n$ and
$\theta_n,d_{n-1},\theta'\models\phi'$,
$\theta_{n-1},d_{n-1},\theta'\models\phi_n\COMP\phi'$.
In the case of $\com=\pop$,
$\theta_{n-2},d_{n-2},\theta'\models\phi_{n-1}\COMP\phi_n\COMP\phi'$
because $\theta_{n-2},d_{n-2},\theta_{n-1}\models\phi_{n-1}$ and
$\theta_{n-1},d_{n-1},\theta'\models\phi_n\COMP\phi'$.
In the case of $\com=\push(j')$,
$\theta',\theta'(j'),\theta'\models\phi''$
because $\phi''\in\Phi_k^{=,j'}$.
Hence, $((q',\theta',v'),((q',\phi''),\allowbreak u'))\in R$ in any case.

On the other hand,
if $((q,\phi_n),u)\vdash_{\calA'}^a ((q',\phi''),u')$, then
$\delta'((q,\phi_n),a,\allowbreak
\phi_{n-1})\ni ((q',\phi''),\com')$
where $u'=\upds(u,\com')$ holds.
By definition,
there exist $\tst$, $\asgn$, $\com$, and
$\phi'\in\phi_n\COMP\Phi_k^{\tst,\asgn}$ such that
$\delta(q,a,\tst)\ni(q',\asgn,\com)$, and
$\com=\pop$ and $\phi''=\phi_{n-1}\COMP\phi_n\COMP\phi'$
if $\com'=\pop$,
$\com=\skip$ and $\phi''=\phi_n\COMP\phi'$ if $\com'=\skip$,
or
$\com=\push(j')$, $\phi''\in\phi'\COMPBL\Phi_j^{=,j'}$
and $\phi'''=\phi_n\COMP\phi'$ if $\com'=\push(\phi''')$.
Because $\theta_{n-1},d_{n-1},\theta_n\models\phi_n$ and
$\phi'\in\phi_n\COMPBLT\Phi_k^{\tst,\asgn}$,
there exists $d\in D$ satisfying
$\theta_n,d,d_{n-1}\models\tst$ and
$\theta_n,d_{n-1},\theta'\models\phi'$
for $\theta'=\theta_n[\asgn\gets d]$.
Therefore,
$(q,\theta_n,v)\vdash_{\calA^{\AUG}}^{(a,d)} (q',\theta',v')$
where
$v'=v(1{:})$, $v$, or
$(\theta'(j'),\theta')v$
if $\com=\pop$, $\skip$, or $\push(j')$, respectively.
We can show that $((q',\theta',v'),((q',\phi''),u'))\in R$
in the same way as the last paragraph.
%\end{proof}
